{% load humanize %}
{% load i18n %}
{% load memberaudit %}

<div>
    {% if error %}
        <p class="text-danger">{{ error }}</p>
    {% else %}
        <ol class="breadcrumb">
            <li><a href="#assets_browser">Locations</a></li>
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="active"><img src="{{ breadcrumb.icon_url }}"/>&nbsp;&nbsp;{{ breadcrumb.name }}</li>
                {% else %}
                    <li><img src="{{ breadcrumb.icon_url }}"/>&nbsp;&nbsp;<a href="#" class="reload-asset-container" data-ajax_children_url="{{ breadcrumb.url }}">
                        {{ breadcrumb.name }}
                    </a></li>
                {% endif %}
            {% endfor %}
            {% comment %} <li class="active"><img src="{{ parent_asset_icon_url }}"/>&nbsp;&nbsp;{{ parent_asset.name_display }} ({{ parent_asset.group_display }})</li> {% endcomment %}
        </ol>

        <div class="table-responsive">
            <table class="table table-striped table-width-fix" id="tab_asset_children">
                <thead>
                    <tr>
                        <th>{% translate 'Name' %}</th>
                        <th>{% translate 'Qty' %}</th>
                        <th>{% translate 'Group' %}</th>
                        <th>{% translate 'Volume' %}</th>
                        <th>{% translate 'Price' %}</th>
                        <th>{% translate 'Total' %}</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody> </tbody>

                <tfoot>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th>{% translate 'Grand Total:' %}</th>
                    <th></th>
                </tfoot>
            </table>
        </div>
    {% endif %}
</div>



<script>
    $(document).ready(function () {
        $('#tab_asset_children').DataTable({
            ajax: {
                url: "{{ data_url }}",
                dataSrc: '',
                cache: false
            },
            columns: [
                { data: 'name',
                    render: {
                        _: 'display',
                        sort: 'sort'
                    }
                },
                {
                    data: 'quantity',
                    render: $.fn.dataTable.render.number( ',', '.', 0 )
                },
                { data: 'group' },
                {
                    data: 'volume',
                    render: $.fn.dataTable.render.number( ',', '.', 2 )
                },
                {
                    data: 'price',
                    render: $.fn.dataTable.render.number( ',', '.', 2 )
                },
                {
                    data: 'total',
                    render: $.fn.dataTable.render.number( ',', '.', 2 )
                },
                { data: 'actions' },
                { data: 'is_container_str' },
                { data: 'is_ship_str' },
            ],
            order: [[0, "asc"], [1, "asc"]],
            columnDefs: [
                { "orderable": false, "targets": [ 6 ] },
                { "visible": false, "targets": [ 7, 8 ] }
            ],
            filterDropDown: {
                columns: [
                    {
                        idx: 7,
                        title: "{% translate 'Container?' %}"
                    },
                    {
                        idx: 8,
                        title: "{% translate 'Ship?' %}"
                    }
                ],
                autoSize: false,
                bootstrap: true
            },
            footerCallback: function ( row, data, start, end, display ) {
                var api = this.api(), data;

                // Remove the formatting to get integer data for summation
                var intVal = function ( i ) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '')*1 :
                        typeof i === 'number' ?
                            i : 0;
                };

                // Total over all pages
                var total = api
                    .column( 5 )
                    .data()
                    .reduce( function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0 );

                // Update footer
                $( api.column( 5 ).footer() ).html(
                    total.toLocaleString()
                );
            }
        });

        /* Reload asset container modal for location or asset container */
        $(document).on('click','.reload-asset-container', function(event) {
            event.stopPropagation();
            event.stopImmediatePropagation();
            var ajax_children_url = $(event.currentTarget).data('ajax_children_url');
            $("#div_assets_main").load(ajax_children_url)
        });

        $('a[href="#assets_browser"]').click(function(){
            $('#div_assets_main').load(
                '{% url "memberaudit:character_asset_locations" character.pk %}'
            )
        });
    });

</script>
